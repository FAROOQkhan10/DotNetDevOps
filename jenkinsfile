pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                sh 'dotnet build DotNetDevOps/DotNetDevOps.csproj'
            }
        }

        stage('Test') {
            steps {
                sh 'dotnet test DotNetDevOps.sln'
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    def imageName = 'weatherimage'
                    def imageTag = 'latest'
                    def containerName = 'weather'
                    def dockerfilePath = "${WORKSPACE}/DotNetDevOps/Dockerfile"
                    def imageFullName = "${imageName}:${imageTag}"
                    
                    // Stop and remove existing container if any
                    sh "docker rm -f ${containerName} || true"
                    
                    // Build Docker image
                    sh "docker build -t ${imageFullName} -f ${dockerfilePath} ${WORKSPACE}"
                }
            }
        }

        stage('Run Container') {
            steps {
                script {
                    def imageId = sh(script: "docker images -q weatherimage:latest", returnStdout: true).trim()
                    echo "Docker image ID: ${imageId}"
                    
                    // Run the new container
                    sh "docker run -d --name ${containerName} -p 8000:80 ${imageId}"
                }
            }
        }
    }
}
